{% extends 'base.html' %}

{% block head %}

    <title>Live Map</title>
    <style>
        #map {
        height: 600px;
        width: 110%;
        border: none;
        margin: 0px;
        padding: 0px;
        }

        
       
    </style>
    <script>
      
      fetch("/stations").then(response => {
        return response.json();
      }).then(data => {
        var stations = data.stations;

        console.log(stations);

        function initMap(stations){
          // The location of dublin
          const dublin = { lat: 53.3446983, lng: -6.2661571 };
          // The map, centered at Dublin
          const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 14,
            center: dublin,
          });
          
          var infoWindow = new google.maps.InfoWindow();

          // loop through stations to add markers
          // code adapted from lecture slides
          stations.forEach(station => {
            var marker = new google.maps.Marker({
              position: {
                lat: station.latitude,
                lng: station.longitude
              },
              map: map,
              title: station.name,
              station_number: station.number
              });

              var contentString = '<div id="content"><h1>' + station.number + '. ' + station.name + '</h1>'
                                  '<div id="station_availability"><p class="station_info">'
                                  'Status: <span class="station_info_item">' + station.status + '</span><br>'
                                  'Bikes available: <span class="station_info_item">' + station.bikes_available + '</span><br>'
                                  'Stands available: <span class="station_info_item">' + station.stands_available + '</span><br>'
                                  '</p></div></div>';

              // code to add click event and make sure only one window is open at a time found at 
              // https://www.aspsnippets.com/Articles/Google-Maps-API-V3-Open-Show-only-one-InfoWindow-at-a-time-and-close-other-InfoWindow.aspx
              (function (marker, contentString) {
                  google.maps.event.addListener(marker, "click", function (e) {
                      // use content string defined before 
                      infoWindow.setContent(contentString);
                      infoWindow.open(map, marker);
                  });
                // call function
              })(marker, contentString);
            
          });
        }

        // call initMap function
        initMap(stations);
      });
    </script>
    
    <!--
    <script>
      var x = document.getElementById("demo");
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }
 
     function showPosition(position) {
       x.innerHTML = "Latitude: " + position.coords.latitude +
       "<br>Longitude: " + position.coords.longitude;
     }
     </script>
     -->

{% endblock %}

{% block body %}

    <div class="box" id="map" style="border: none;">
        <p>Map</p>
        <script src="https://maps.googleapis.com/maps/api/js?key={APIKEY}&callback=initMap" async></script>
    </div>

{% endblock %}