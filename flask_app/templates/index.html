{% extends 'base.html' %}

{% block head %}

    <title>Live Map</title>
    <style>
        #map {
        height: 600px;
        width: 110%;
        border: none;
        margin: 0px;
        padding: 0px;
        }

        
       
    </style>
    <script>
      
      fetch("/stations").then(response => {
                return response.json();
              }).then(data => {

                var stations = data.stations;
                console.log(stations);
                // The location of dublin
                const dublin = { lat: 53.3446983, lng: -6.2661571 };
                // The map, centered at Dublin
                const map = new google.maps.Map(document.getElementById("map"), {
                  zoom: 14,
                  center: dublin,
                });
                
                // loop through stations to add markers
                // code adapted from lecture slides
                stations.forEach(station => {
                  var marker = new google.maps.Marker({
                    position: {
                      lat: station.latitude,
                      lng: station.longitude
                    },
                    map: map,
                    title: station.name,
                    station_number: station.number
                    });
                  
                  var contentString = '<div id="content"><h1>' + station.number + '. ' + station.name + '</h1>'
                                  '<div id="station_availability"><p class="station_info">'
                                  'Status: <span class="station_info_item">' + station.status + '</span><br>'
                                  'Bikes available: <span class="station_info_item">' + station.bikes_available + '</span><br>'
                                  'Stands available: <span class="station_info_item">' + station.stands_available + '</span><br>'
                                  '</p></div></div>';

                  // code to close previous window from stack overflow user Aamir Afridi
                  // https://stackoverflow.com/questions/2223574/google-maps-auto-close-open-infowindows
                  var prevWindow = false;
                  var infoWindow = new google.maps.InfoWindow({
                    content: contentString
                  });

                  marker.addListener('click', function(){
                    // close previous window
                    if(prevWindow){
                      prevWindow.close();
                    }
                    // open new window
                    prevWindow = infoWindow;
                    infoWindow.open(map,marker);
                  });
                });
              });
              
            

        
      
      
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAATWob_anm9tXOgwSN35vcZIal8Q5oZto&callback=initMap" async>
      var x = document.getElementById("demo");
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }
 
     function showPosition(position) {
       x.innerHTML = "Latitude: " + position.coords.latitude +
       "<br>Longitude: " + position.coords.longitude;
     }
     </script>

{% endblock %}

{% block body %}

    <div class="box" id="map" style="border: none;">
        <p>Map</p>
    </div>

{% endblock %}